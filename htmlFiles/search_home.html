<main class="my-4 mx-6">
    <!-- <h2>Enter GEO Accession IDs:</h2> -->
    <p>You can use this tool to find datasets from <a href="https://www.ncbi.nlm.nih.gov/geo/" target="_blank">Gene Expression Omnibus (GEO)</a>. First, go to GEO to find at least 2 datasets that align with your research interests. Then, you can either enter the accession IDs below or you can download a file with these IDs from GEO and import them below:</p>

    <div class="search-container" style="position: relative;">
        <textarea id="inputText" class="content is-medium textarea has-fixed-size textarea is-hovered textarea is-info mt-2" placeholder="Enter IDs (ie. GSE123, GSE456)" rows="10"></textarea>
        <input type="file" id="fileInput" style="display: none;" />      
        
        <!-- Paperclip Icon (File Input) -->
        <div class="icon fas fa-2x" style="cursor: pointer; position: absolute; bottom: 25px; left: 15px; z-index: 1;">
            <i class="fa-solid fa-paperclip"></i>
        </div>  

        <!-- Information Icon -->
        <div id="info-icon" class="info-icon" title="Click for detailed instructions!" style="cursor: pointer; position: absolute; bottom: 5px; left: 50px;">
            <i class="fa-solid fa-circle-info"></i>
        </div>
    </div>
    
    <!-- Modal Window -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close-btn">&times;</span>
                <p>Welcome!</p><br>
                <p>To find datasets, you will need to start with one or more accession IDs from Gene Expression Omnibus (GEO). If you do not already have one, visit <a href="https://www.ncbi.nlm.nih.gov/geo/" target="_blank">https://www.ncbi.nlm.nih.gov/geo/</a> and enter a keyword in the search bar for data pertaining to your research. Next:</p><br>
                <ul>
                    <li>1. Manually enter one or more IDs in the text box here (on GEOfinder), formatted <code>GSExxx</code>. If you are entering more than one ID, please separate your list by commas or newlines.</li>
                    <li>OR:</li>
                    <li>2. Upload a file containing the datasets you found on GEO. To get this file:
                        <ul>
                            <li>Check the boxes next to desired datasets &gt; scroll to the bottom of the page &gt; click “Send to:” button &gt; select “file” &gt; format: summary (txt) &gt; create file &gt; click on the paperclip icon here on GEOfinder &gt; upload your file.</li>
                        </ul>
                    </li>
                </ul>
        </div>
    </div>

    <div id="errorPlaceholder"><p></p></div>

    <h2>Filters:</h2>
    <div class="submit-container">
        <button id="submitButton" class="button is-info subtitle is-4 has-text-black" disabled>Submit</button>
    </div>
    <div class="boxes">
        <div class="columns">
            <div class="column is-2"><strong>Number of Samples:</strong><br>
                <input type="checkbox" id="a" name="a" value="1-10" checked>
                <label for="a">1-10</label><br>
                <input type="checkbox" id="b" name="b" value="11-50" checked>
                <label for="b">11-50</label><br>
                <input type="checkbox" id="c" name="c" value="51-100" checked>
                <label for="c">51-100</label><br>
                <input type="checkbox" id="d" name="d" value="101-500" checked>
                <label for="d">101-500</label><br>
                <input type="checkbox" id="e" name="e" value="501-1000" checked>
                <label for="e">501-1000</label><br>
                <input type="checkbox" id="f" name="f" value="1000+" checked>
                <label for="f">1000+</label><br>
            </div>
            <div class="column is-2"><strong>Experiment Type:</strong><br>
                <input type="checkbox" id="rnaSeq" name="rnaSeq" value="RNA sequencing" checked>
                <label for="rnaSeq">Expression profiling by high throughput sequencing</label><br>
                <input type="checkbox" id="microarr" name="microarr" value="Microarray" checked>
                <label for="microarr">Expression profiling by array</label>
            </div> 
            <div class="column is-2"><strong>Year Released:</strong><br>
                <div class="filter">
                    <div style="margin-top: 10px;">
                        <label for="startYear">Custom range: </label> <br>
                        <input type="number" id="startYear" placeholder="2001" min="2001" max="2024" value="2001">
                        <input type="number" id="endYear" placeholder="2024" min="2001" max="2024" value="2024">
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
$(document).ready(function() {
    $('#inputText').keyup(function() {
        checkTextareaContent();
    });

    function checkTextareaContent(){
        var inputText = $('#inputText').val();
        if (inputText.length > 0) {
            $('#submitButton').prop('disabled', false);
            $(this).removeClass('grayed-out'); 
        } else {
            $('#submitButton').prop('disabled', true);
        }
    }

const fileInput = document.getElementById('fileInput');
const inputText = document.getElementById('inputText');
const errorPlaceholder = document.getElementById('errorPlaceholder');

// Get modal and icon elements
const modal = document.getElementById('info-modal');
const infoIcon = document.getElementById('info-icon');
const closeModalBtn = document.getElementById('close-modal');

// When the user clicks on the information icon, open the modal
infoIcon.addEventListener('click', () => {
    modal.style.display = "block";
});

// When the user clicks on the "X" button, close the modal
closeModalBtn.addEventListener('click', () => {
    modal.style.display = "none";
});

// When the user clicks anywhere outside of the modal, close it
window.addEventListener('click', (event) => {
    if (event.target === modal) {
        modal.style.display = "none";
    }
});

// Get the paperclip icon element
const uploadIcon = document.querySelector('.icon i'); // Using querySelector to select the icon

// Trigger the file input when the paperclip icon is clicked
uploadIcon.addEventListener('click', function() {
    fileInput.click(); 
});

fileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    
    if (file) {

        const reader = new FileReader();
        reader.onload = function(e) {
            const textContent = e.target.result; // file's text content

            const pattern = /Accession: (GSE\d+)/g; // regex pattern
            const matches = [];
            let match;
            while((match = pattern.exec(textContent)) !== null) {
                matches.push(match[1]);
            }

            if (matches.length > 0){
                inputText.value =inputText.value + matches.join(', ');
            } else {
                errorPlaceholder.innerHTML = "<span style='color: red;'>Didn't find any GEO accession ID's in this file. It could be because the file was not retrieved from GEO correctly. Check our instructions and contact us if you still have questions!</span>";
            }
            checkTextareaContent(); // Presumably this is some function you have defined
        };
        reader.readAsText(file);
        fileInput.value = "";
    }
});

    $('#submitButton').click(function() {
        var inputText = $('#inputText').val();
        var checkboxValues = {};
        
        $('input[type=checkbox]').each(function() {
            checkboxValues[$(this).attr('name')] = $(this).is(':checked') ? $(this).val() : '';
        });

        $(this).prop('disabled', true); // Disable the button
        $('#inputText').addClass('grayed-out'); // Add gray color and disable textarea

        $.ajax({
            type: 'POST',
            url: '/query',
            data: {
                ids: inputText,
                a: checkboxValues['a'],
                b: checkboxValues['b'],
                c: checkboxValues['c'],
                d: checkboxValues['d'],
                e: checkboxValues['e'],
                f: checkboxValues['f'],
                rnaSeq: checkboxValues['rnaSeq'],
                microarr: checkboxValues['microarr'],
                startYear: document.getElementById('startYear').value,
                endYear: document.getElementById('endYear').value
            },
            success: function(response) {
                // Handle success response
                console.log(response);
                $('#content').html(response);
                $('#inputText').removeClass('grayed-out');
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(xhr.responseText);
            }
        });
    });
});
</script>