<main class="my-4 mx-6">
    <h2>Enter GEO Accession IDs:</h2>

    <div class="search-container" style="position: relative;">
        <textarea id="inputText" class="content is-medium textarea has-fixed-size textarea is-hovered textarea is-info mt-2" placeholder="Enter IDs (ie. GSE123, GSE456)" rows="10"></textarea>
        <input type="file" id="fileInput" style="display: none;" />
        <span class="icon fas fa-2x" style="cursor: pointer; position: absolute; bottom: 0; left: 0; z-index: 1;">
            <i class="fa-solid fa-paperclip"></i>
        </span>        
    </div>
    <div id="errorPlaceholder"><p></p></div>
    <h2>Filters:</h2>
    <div class="submit-container">
        <button id="submitButton" class="button is-info subtitle is-4 has-text-black" disabled>Submit</button>
    </div>
    <div class="boxes">
        <div class="columns">
            <div class="column is-2"><strong>Number of Samples:</strong><br>
                <input type="checkbox" id="a" name="a" value="1-10" checked>
                <label for="a">1-10</label><br>
                <input type="checkbox" id="b" name="b" value="11-50" checked>
                <label for="b">11-50</label><br>
                <input type="checkbox" id="c" name="c" value="51-100" checked>
                <label for="c">51-100</label><br>
                <input type="checkbox" id="d" name="d" value="101-500" checked>
                <label for="d">101-500</label><br>
                <input type="checkbox" id="e" name="e" value="501-1000" checked>
                <label for="e">501-1000</label><br>
                <input type="checkbox" id="f" name="f" value="1000+" checked>
                <label for="f">1000+</label><br>
            </div>
            <div class="column is-2"><strong>Experiment Type:</strong><br>
                <input type="checkbox" id="rnaSeq" name="rnaSeq" value="RNA sequencing" checked>
                <label for="rnaSeq">Expression profiling by high throughput sequencing</label><br>
                <input type="checkbox" id="microarr" name="microarr" value="Microarray" checked>
                <label for="microarr">Expression profiling by array</label>
            </div> 
            <div class="column is-2"><strong>Year Released:</strong><br>
                <div class="filter">
                    <div style="margin-top: 10px;">
                        <label for="startYear">Custom range: </label> <br>
                        <input type="number" id="startYear" placeholder="2001" min="2001" max="2024" value="2001">
                        <input type="number" id="endYear" placeholder="2024" min="2001" max="2024" value="2024">
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
$(document).ready(function() {
    $('#inputText').keyup(function() {
        checkTextareaContent();
    });

    function checkTextareaContent(){
        var inputText = $('#inputText').val();
        if (inputText.length > 0) {
            $('#submitButton').prop('disabled', false);
            $(this).removeClass('grayed-out'); // Remove grayed-out class to turn text black
        } else {
            $('#submitButton').prop('disabled', true);
        }
    }

const fileInput = document.getElementById('fileInput');
const inputText = document.getElementById('inputText');
const errorPlaceholder = document.getElementById('errorPlaceholder');

// Get the paperclip icon element
const uploadIcon = document.querySelector('.icon i'); // Using querySelector to select the icon

// Trigger the file input when the paperclip icon is clicked
uploadIcon.addEventListener('click', function() {
    fileInput.click(); 
});

fileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    
    if (file) {

        const reader = new FileReader();
        reader.onload = function(e) {
            const textContent = e.target.result; // file's text content

            const pattern = /Accession: (GSE\d+)/g; // regex pattern
            const matches = [];
            let match;
            while((match = pattern.exec(textContent)) !== null) {
                matches.push(match[1]);
            }

            if (matches.length > 0){
                inputText.value =inputText.value + matches.join(', ');
            } else {
                errorPlaceholder.innerHTML = "<span style='color: red;'>Didn't find any GEO accession ID's in this file. It could be because the file was not retrieved from GEO correctly. Check our instructions and contact us if you still have questions!</span>";
            }
            checkTextareaContent(); // Presumably this is some function you have defined
        };
        reader.readAsText(file);
        fileInput.value = "";
    }
});

    $('#submitButton').click(function() {
        var inputText = $('#inputText').val();
        var checkboxValues = {};
        
        $('input[type=checkbox]').each(function() {
            checkboxValues[$(this).attr('name')] = $(this).is(':checked') ? $(this).val() : '';
        });

        $(this).prop('disabled', true); // Disable the button
        $('#inputText').addClass('grayed-out'); // Add gray color and disable textarea

        $.ajax({
            type: 'POST',
            url: '/query',
            data: {
                ids: inputText,
                a: checkboxValues['a'],
                b: checkboxValues['b'],
                c: checkboxValues['c'],
                d: checkboxValues['d'],
                e: checkboxValues['e'],
                f: checkboxValues['f'],
                rnaSeq: checkboxValues['rnaSeq'],
                microarr: checkboxValues['microarr'],
                startYear: document.getElementById('startYear').value,
                endYear: document.getElementById('endYear').value
            },
            success: function(response) {
                // Handle success response
                console.log(response);
                $('#content').html(response);
            },
            error: function(xhr, status, error) {
                // Handle error
                console.error(xhr.responseText);
            }
        });
    });
});
</script>